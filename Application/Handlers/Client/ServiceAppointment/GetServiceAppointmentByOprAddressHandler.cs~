using System;
using CMPNatural.Application.Commands;
using CMPNatural.Core.Entities;
using CMPNatural.Core.Repositories;
using MediatR;
using ScoutDirect.Application.Responses;
using System.Threading;
using System.Threading.Tasks;
using System.Collections.Generic;
using System.Linq;
using CMPNatural.Core.Enums;
using CMPNatural.Application.Responses.ClientServiceAppointment;
using Microsoft.EntityFrameworkCore;

namespace CMPNatural.Application.Handlers
{

    public class GetServiceAppointmentByOprAddressHandler : IRequestHandler<GetServiceAppointmentByOprAddressCommand, CommandResponse<List<ClientServiceAppointment>>>
    {
        private readonly IBaseServiceAppointmentRepository _serviceAppointmentRepository;

        public GetServiceAppointmentByOprAddressHandler(IBaseServiceAppointmentRepository billingInformationRepository)
        {
            _serviceAppointmentRepository = billingInformationRepository;
        }

        public async Task<CommandResponse<List<ClientServiceAppointment>>> Handle(GetServiceAppointmentByOprAddressCommand request, CancellationToken cancellationToken)
        {
            var result = (await _serviceAppointmentRepository.GetAsync(
                (p)=> p.OperationalAddressId == request.OperationalAddressId &&
                p.CompanyId == request.CompanyId &&
                p.IsEmegency != true &&
                (
                p.Status == ServiceStatus.Draft
                ||
                p.Status == ServiceStatus.Proccessing
                ||
                p.Status == ServiceStatus.Scaduled) &&
                //
                p.Status != ServiceStatus.Canceled, query=> query.Include(x=>x.Invoice).Include(x=>x.ProductPrice)
                )
                ).ToList();

            var data = result.GroupBy(x => x.ProductPrice.Id);
            var dataset= data.Select(x => {
            var invoiceNumber = x.FirstOrDefault().Invoice.InvoiceNumber;
             return new ClientServiceAppointment()
               {
                   Draft = x.Where(p => p.Status == ServiceStatus.Draft).FirstOrDefault(),
                   Current = x.Where(p => p.Status == ServiceStatus.Proccessing).FirstOrDefault(),
                   Next = x.Where(p => p.Status == ServiceStatus.Scaduled).FirstOrDefault(),
                   ServiceId = x.Where(p => p.ProductPriceId == x.Key).FirstOrDefault().ProductId,
                   CanTerminate = x.Where(p => p.Status == ServiceStatus.Scaduled).Any(),
                   InvoiceNumber = invoiceNumber
             };
           }
           ).ToList();

            return new Success<List<ClientServiceAppointment>>() { Data = dataset };

        }

    }
}

